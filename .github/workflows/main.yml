name: Playwright Tests with Allure and GitHub Pages Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.12"
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 40

    strategy:
      matrix:
        browser: [chromium]
      fail-fast: false

    steps:
      # ============================================
      # Checkout & Setup
      # ============================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      # ============================================
      # Environment Configuration from .env.example
      # ============================================
      - name: ğŸ“‹ Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "âŒ .env.example file not found in repository root!"
            echo "Please create .env.example with your configuration"
            exit 1
          fi
          echo "âœ… .env.example found"
          echo ""
          echo "ğŸ“„ Template contents:"
          cat .env.example

      - name: ğŸ”§ Create .env from .env.example with secrets
        run: |
          echo "ğŸ”§ Creating .env from .env.example template..."
          
          # Copy .env.example as starting point
          cp .env.example .env
          
          # Override with GitHub Secrets if they exist
          
          # Application URLs
          if [ ! -z "${{ secrets.BASE_URL }}" ]; then
            sed -i "s|^BASE_URL=.*|BASE_URL=${{ secrets.BASE_URL }}|" .env
            echo "âœ… BASE_URL overridden from secret"
          fi
          
          if [ ! -z "${{ secrets.LOGIN_URL }}" ]; then
            sed -i "s|^LOGIN_URL=.*|LOGIN_URL=${{ secrets.LOGIN_URL }}|" .env
            echo "âœ… LOGIN_URL overridden from secret"
          fi
          
          # Test Credentials
          if [ ! -z "${{ secrets.TEST_USERNAME }}" ]; then
            sed -i "s|^TEST_USERNAME=.*|TEST_USERNAME=${{ secrets.TEST_USERNAME }}|" .env
            echo "âœ… TEST_USERNAME overridden from secret"
          fi
          
          if [ ! -z "${{ secrets.TEST_PASSWORD }}" ]; then
            sed -i "s|^TEST_PASSWORD=.*|TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}|" .env
            echo "âœ… TEST_PASSWORD overridden from secret"
          fi
          
          # Browser Settings - Force CI values
          sed -i "s|^HEADLESS=.*|HEADLESS=true|" .env
          sed -i "s|^SLOW_MO=.*|SLOW_MO=0|" .env
          sed -i "s|^TIMEOUT=.*|TIMEOUT=30000|" .env
          
          # Video Recording - Disable in CI for performance
          sed -i "s|^RECORD_VIDEO=.*|RECORD_VIDEO=false|" .env
          
          # Add CI-specific variables
          echo "" >> .env
          echo "# CI/CD Variables (Auto-generated)" >> .env
          echo "CI=true" >> .env
          echo "BROWSER=${{ matrix.browser }}" >> .env
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .env
          echo "GITHUB_RUN_NUMBER=${{ github.run_number }}" >> .env
          echo "GITHUB_SHA=${{ github.sha }}" >> .env
          echo "GITHUB_REF=${{ github.ref }}" >> .env
          echo "GITHUB_ACTOR=${{ github.actor }}" >> .env
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> .env
          
          echo ""
          echo "âœ… .env file created successfully"

      - name: âœ… Verify and display .env configuration
        run: |
          if [ ! -f .env ]; then
            echo "âŒ .env file was not created!"
            exit 1
          fi
          
          echo "âœ… .env file exists"
          echo "ğŸ“Š File size: $(wc -c < .env) bytes"
          echo "ğŸ“ Total lines: $(wc -l < .env)"
          echo ""
          echo "ğŸ“‹ Configuration (sensitive values masked):"
          echo "================================================"
          
          # Show non-sensitive values
          grep -v -E "PASSWORD|SECRET|TOKEN|KEY" .env | grep -v "^#" | grep -v "^$" || true
          
          echo "================================================"
          echo ""
          echo "ğŸ”’ Sensitive values (masked):"
          grep -E "PASSWORD|SECRET|TOKEN|KEY" .env | sed 's/=.*/=***MASKED***/g' || echo "None found"
          echo "================================================"

      # ============================================
      # Install Dependencies
      # ============================================
      - name: ğŸ“¦ Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install allure-pytest python-dotenv
          echo "âœ… Python dependencies installed"

      - name: ğŸ­ Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: ğŸ­ Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          python -m playwright install chromium --with-deps
          echo "âœ… Playwright Chromium installed with dependencies"

      - name: ğŸ­ Install Playwright system dependencies only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          python -m playwright install-deps chromium
          echo "âœ… Playwright system dependencies updated"

      # ============================================
      # Install Allure
      # ============================================
      - name: ğŸ“Š Cache Allure CLI
        id: allure-cache
        uses: actions/cache@v4
        with:
          path: /opt/allure
          key: ${{ runner.os }}-allure-cli-v2

      - name: ğŸ“Š Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest \
            | grep browser_download_url | grep zip | cut -d '"' -f 4)
          echo "ğŸ“¥ Downloading Allure CLI from: $LATEST_URL"
          wget -q $LATEST_URL -O allure.zip
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq unzip default-jre
          
          unzip -q allure.zip
          ALLURE_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "allure-[0-9]*" | head -n 1)
          sudo mv "$ALLURE_DIR" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure
          
          echo "âœ… Allure CLI installed"

      - name: ğŸ“Š Verify Allure installation
        run: |
          allure --version
          which allure
          echo "âœ… Allure CLI is ready"

      # ============================================
      # Prepare Test Environment
      # ============================================
      - name: ğŸ“ Create test result directories
        run: |
          mkdir -p allure-results
          mkdir -p test-results/screenshots
          mkdir -p test-results/videos
          mkdir -p test-results/traces
          echo "âœ… Test directories created"

      # ============================================
      # Run Tests
      # ============================================
      - name: ğŸ§ª Run Playwright Page Tests
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ§ª Starting Playwright Test Execution"
          echo "================================================"
          echo "