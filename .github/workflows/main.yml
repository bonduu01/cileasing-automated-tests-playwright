name: Playwright Tests with Allure Reports

on:
  push:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test Suite to Run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - regression
      browser:
        description: 'Browser to test'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'
  ALLURE_VERSION: '2.30.0'
  PLAYWRIGHT_BROWSERS_PATH: '0'

jobs:
  # Job 1: Run Smoke Tests (always runs first)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Run if: smoke selected, all selected, or not workflow_dispatch (push/schedule)
    if: github.event.inputs.test_suite == 'smoke' || github.event.inputs.test_suite == 'all' || github.event_name != 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install --with-deps ${{ github.event.inputs.browser || 'chromium' }}
          playwright --version

      - name: Create directories
        run: |
          mkdir -p screenshots
          mkdir -p allure-results
          mkdir -p test-results

      - name: Run Smoke Tests
        id: smoke_tests
        continue-on-error: false
        env:
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_ENV: ci
          BROWSER: ${{ github.event.inputs.browser || 'chromium' }}
        run: |
          set +e
          
          pytest tests_pages/ -m smoke \
            --alluredir=allure-results/smoke \
            --clean-alluredir \
            --browser=${{ github.event.inputs.browser || 'chromium' }} \
            --tracing=retain-on-failure \
            --screenshot=only-on-failure \
            --video=retain-on-failure \
            -v \
            --tb=short \
            --junit-xml=junit-smoke.xml
          
          TEST_EXIT_CODE=$?
          
          if [ $TEST_EXIT_CODE -eq 4 ]; then
            echo "âŒ FATAL: Pytest collection failed (import error, syntax error, etc.)"
            exit 1
          elif [ $TEST_EXIT_CODE -eq 3 ]; then
            echo "âŒ FATAL: Internal pytest error"
            exit 1
          elif [ $TEST_EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ WARNING: Tests interrupted by user or system"
            exit $TEST_EXIT_CODE
          elif [ $TEST_EXIT_CODE -eq 1 ]; then
            echo "âš ï¸ Some tests failed (this is acceptable for reporting)"
            exit 0
          elif [ $TEST_EXIT_CODE -eq 5 ]; then
            echo "âš ï¸ No tests collected"
            exit 1
          else
            echo "âœ… Tests completed successfully"
            exit 0
          fi

      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            allure-results/
            screenshots/
            test-results/
            junit-smoke.xml
          retention-days: 30

  # Job 2: Run Regression Tests (runs AFTER smoke-tests complete)
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 7
    needs: smoke-tests  # â­ KEY: Waits for smoke-tests to finish
    # Run if: regression selected, all selected, or not workflow_dispatch
    # Also check if smoke-tests didn't fail catastrophically (allow failure for test assertions, not setup)
    if: |
      always() && 
      (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'failure') &&
      (github.event.inputs.test_suite == 'regression' || github.event.inputs.test_suite == 'all' || github.event_name != 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install --with-deps ${{ github.event.inputs.browser || 'chromium' }}
          playwright --version

      - name: Create directories
        run: |
          mkdir -p screenshots
          mkdir -p allure-results
          mkdir -p test-results

      - name: Run Regression Tests
        id: regression_tests
        continue-on-error: false
        env:
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_ENV: ci
          BROWSER: ${{ github.event.inputs.browser || 'chromium' }}
        run: |
          set +e
          
          pytest tests_pages/ -m regression \
            --alluredir=allure-results/regression \
            --clean-alluredir \
            --browser=${{ github.event.inputs.browser || 'chromium' }} \
            --tracing=retain-on-failure \
            --screenshot=only-on-failure \
            --video=retain-on-failure \
            -v \
            --tb=short \
            --junit-xml=junit-regression.xml
          
          TEST_EXIT_CODE=$?
          
          if [ $TEST_EXIT_CODE -eq 4 ]; then
            echo "âŒ FATAL: Pytest collection failed (import/syntax error)"
            exit 1
          elif [ $TEST_EXIT_CODE -eq 3 ]; then
            echo "âŒ FATAL: Internal pytest error"
            exit 1
          elif [ $TEST_EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ WARNING: Tests interrupted"
            exit $TEST_EXIT_CODE
          elif [ $TEST_EXIT_CODE -eq 1 ]; then
            echo "âš ï¸ Some tests failed (acceptable for reporting)"
            exit 0
          elif [ $TEST_EXIT_CODE -eq 5 ]; then
            echo "âš ï¸ No tests collected"
            exit 1
          else
            echo "âœ… Tests completed successfully"
            exit 0
          fi

      - name: Upload Regression Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-results
          path: |
            allure-results/
            screenshots/
            test-results/
            junit-regression.xml
          retention-days: 30

  # Job 3: Generate and Deploy Allure Report
  generate-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [ smoke-tests, regression-tests ]  # Waits for both
    if: always()  # Run even if tests fail

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if any tests ran
        id: check_tests
        run: |
          smoke_ran="${{ needs.smoke-tests.result }}"
          regression_ran="${{ needs.regression-tests.result }}"
          
          # Check if either job actually ran (not skipped)
          if [ "$smoke_ran" != "skipped" ] || [ "$regression_ran" != "skipped" ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
            echo "âœ… At least one test suite ran"
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
            echo "âŒ All test suites were skipped"
          fi

      - name: Download all test results
        if: steps.check_tests.outputs.has_results == 'true'
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: "*-test-results"  # Download both smoke and regression

      - name: Merge Allure Results
        if: steps.check_tests.outputs.has_results == 'true'
        run: |
          mkdir -p allure-results
          echo "Merging allure results from all test suites..."
          
          # Find and merge all allure-results subdirectories
          find all-results -type d -name "allure-results" | while read dir; do
            echo "Copying from: $dir"
            cp -r "$dir"/* allure-results/ 2>/dev/null || true
          done
          
          echo ""
          echo "=== Merged Results ==="
          ls -lah allure-results/
          echo "Total files: $(find allure-results -type f | wc -l)"
          echo "JSON result files: $(find allure-results -name "*-result.json" | wc -l)"
          
          # Create environment.properties
          cat > allure-results/environment.properties << EOF
          Browser=${{ github.event.inputs.browser || 'chromium' }}
          Framework=Playwright
          Engineer=Peter Molokwu
          Environment=Staging
          Python.Version=3.11
          Platform=Ubuntu Latest
          Test.Framework=Pytest
          Build.Number=${{ github.run_number }}
          Commit=${{ github.sha }}
          Branch=${{ github.ref_name }}
          EOF
          
          result_count=$(find allure-results -name "*-result.json" | wc -l)
          if [ $result_count -eq 0 ]; then
            echo "âŒ ERROR: No test result JSON files found!"
            exit 1
          else
            echo "âœ… SUCCESS: Found $result_count test result files"
          fi

      - name: Get Allure history from gh-pages
        if: steps.check_tests.outputs.has_results == 'true'
        continue-on-error: true
        run: |
          echo "Attempting to fetch allure history..."
          
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "gh-pages branch exists, fetching history..."
            git fetch origin gh-pages:gh-pages
            git checkout gh-pages
          
            if [ -d "allure-history" ]; then
              echo "Found allure-history directory"
              mkdir -p /tmp/allure-history
              cp -r allure-history/* /tmp/allure-history/ 2>/dev/null || true
              echo "History backed up to /tmp/allure-history"
            fi
          
            git checkout -
          else
            echo "gh-pages branch does not exist yet (first run)"
          fi

      - name: Install Allure
        if: steps.check_tests.outputs.has_results == 'true'
        run: |
          echo "Installing Allure ${ALLURE_VERSION}..."
          wget -q https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz
          tar -zxf allure-${ALLURE_VERSION}.tgz
          sudo mv allure-${ALLURE_VERSION} /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: Restore Allure history
        if: steps.check_tests.outputs.has_results == 'true'
        continue-on-error: true
        run: |
          if [ -d "/tmp/allure-history" ]; then
            echo "Restoring allure history..."
            mkdir -p allure-results/history
            cp -r /tmp/allure-history/* allure-results/history/ 2>/dev/null || true
            echo "History restored"
          fi

      - name: Generate Allure Report
        if: steps.check_tests.outputs.has_results == 'true'
        run: |
          echo "Generating Allure report..."
          allure generate allure-results -o allure-report --clean
          echo "Report generated successfully"

      - name: Prepare deployment directory
        if: steps.check_tests.outputs.has_results == 'true'
        run: |
          mkdir -p gh-pages-deploy
          
          cp -r allure-report/* gh-pages-deploy/
          
          if [ -d "allure-report/history" ]; then
            mkdir -p gh-pages-deploy/allure-history
            cp -r allure-report/history/* gh-pages-deploy/allure-history/
            echo "History saved for next run"
          fi
          
          touch gh-pages-deploy/.nojekyll
          
          echo "Deployment directory prepared"

      - name: Deploy to GitHub Pages
        if: steps.check_tests.outputs.has_results == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./gh-pages-deploy
          keep_files: false
          enable_jekyll: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Allure report - Build ${{ github.run_number }}'

      - name: Report generation failed
        if: steps.check_tests.outputs.has_results == 'false'
        run: |
          echo "### âŒ Report Generation Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All test suites were skipped." >> $GITHUB_STEP_SUMMARY

      - name: Add report link to summary
        if: steps.check_tests.outputs.has_results == 'true'
        run: |
          echo "### ðŸ“Š Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Report will be available in 1-2 minutes after deployment completes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ github.event.inputs.browser || 'chromium' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Job 4: Notify Results
  notify-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [ smoke-tests, regression-tests, generate-report ]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ§ª Playwright Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Order" >> $GITHUB_STEP_SUMMARY
          echo "1. Smoke Tests â†’ 2. Regression Tests (sequential)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Smoke Tests Status
          smoke_result="${{ needs.smoke-tests.result }}"
          if [ "$smoke_result" == "success" ]; then
            echo "### âœ… Smoke Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "$smoke_result" == "failure" ]; then
            echo "### âŒ Smoke Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          elif [ "$smoke_result" == "skipped" ]; then
            echo "### â­ï¸ Smoke Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          elif [ "$smoke_result" == "cancelled" ]; then
            echo "### â±ï¸ Smoke Tests: TIMEOUT" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Regression Tests Status
          regression_result="${{ needs.regression-tests.result }}"
          if [ "$regression_result" == "success" ]; then
            echo "### âœ… Regression Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "$regression_result" == "failure" ]; then
            echo "### âŒ Regression Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          elif [ "$regression_result" == "skipped" ]; then
            echo "### â­ï¸ Regression Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          elif [ "$regression_result" == "cancelled" ]; then
            echo "### â±ï¸ Regression Tests: TIMEOUT" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Report Status
          if [ "${{ needs.generate-report.result }}" == "success" ]; then
            echo "### âœ… Report Generation: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Report Generation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Detailed Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.generate-report.result }}" == "success" ]; then
            echo "ðŸ”— [View Full Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Report not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ github.event.inputs.browser || 'chromium' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY